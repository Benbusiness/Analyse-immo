<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Rentabilité Immobilière</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); }
        .card-gradient { background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%); }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); transition: all 0.3s ease; }
        .btn-primary:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); transition: all 0.3s ease; }
        .btn-secondary:hover { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3); }
        .progress-bar { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .risk-low { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-left: 4px solid #10b981; }
        .risk-medium { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; }
        .risk-high { background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border-left: 4px solid #ef4444; }
        .strategy-card { transition: all 0.3s ease; }
        .strategy-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        input:focus, select:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2) !important; border-color: #10b981 !important; }
        .badge-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .badge-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .badge-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .animate-fade-in { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .nav-pill { transition: all 0.3s ease; }
        .nav-pill.active { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; }
        .nav-pill:hover { background: linear-gradient(135deg, #047857 0%, #065f46 100%); color: white; }
        canvas { border-radius: 12px; }
        .opacity-50 { opacity: 0.5; }
    </style>
</head>
<body class="gradient-bg text-slate-800">
    <!-- Contenu HTML du formulaire et des étapes (inchangé, sauf ID liés aux calculs) -->
    <!-- Étape 2: Général / Estimations en temps réel -->
    <section id="general-property-section" class="p-6 bg-white rounded-xl shadow-lg m-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Détails du bien</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label>Surface (m²)</label>
                <input id="surface" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label>Prix d'achat (€)</label>
                <input id="purchase-price" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label>Taux crédit (%)</label>
                <input id="interest-rate" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label>Mensualité (€)</label>
                <input id="monthly-payment" type="text" class="w-full border rounded p-2" disabled />
            </div>
            <div>
                <label>Prix au m²</label>
                <div id="price-per-m2" class="font-semibold text-lg">—</div>
            </div>
        </div>
    </section>

    <!-- Étape 3: Cashflow / Resale (simplifiée) -->
    <section id="property-section" class="p-6 bg-white rounded-xl shadow-lg m-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Analyse du projet</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label>Loyer (€)</label>
                <input id="rent-price" type="number" class="w-full border rounded p-2" />
            </div>
            <div>
                <label>Charges (€)</label>
                <input id="charges" type="number" class="w-full border rounded p-2" />
            </div>
        </div>
        <div class="mt-4">
            <p>Cashflow estimé: <span id="cashflow-result">—</span></p>
        </div>
    </section>

    <!-- Résultats finaux -->
    <section id="results-section" class="p-6 bg-white rounded-xl shadow-lg m-6 hidden">
        <h2 class="text-2xl font-bold mb-4">Résultats finaux</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p>Cashflow annuel: <span id="annual-cashflow">—</span></p>
                <p>Investissement total: <span id="total-investment">—</span></p>
            </div>
            <div>
                <p>Risque: <span id="risk-level">—</span></p>
            </div>
        </div>
        <div id="evaluation" class="mt-4"></div>
        <button id="verdict-btn" class="btn-primary mt-4">Faire offre</button>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let selectedStrategy = 'cashflow';
        let projectionType = 'medium';

        const WORKS_PRESETS = {
            aucun: { pct: 0.00, label: 'Aucun', desc: "Aucun travaux : bien en état d'usage / habitable." },
            raffraichissement: { pct: 0.03, label: 'Raffraichissement', desc: "Raffraichissement : peintures, sols, petits ajustements." },
            renovation: { pct: 0.08, label: 'Rénovation', desc: "Rénovation : cuisine/SDB, électricité/plomberie partielle." },
            rehabilitation: { pct: 0.20, label: 'Réhabilitation', desc: "Travaux lourds, reprise globale du logement." },
            custom: { pct: null, label: 'Montant exact', desc: "Montant exact : saisissez votre budget travaux." }
        };

        function calculateMonthlyPayment(totalAmountToFinance, loanTerm, interestRate) {
            const monthlyRate = interestRate / 12;
            const totalPayments = loanTerm * 12;
            if (monthlyRate > 0) {
                return totalAmountToFinance * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);
            }
            return totalAmountToFinance / totalPayments;
        }

        async function calculateGeneralPropertyData() {
            const purchasePrice = parseFloat(document.getElementById('purchase-price')?.value) || 0;
            const surface = parseFloat(document.getElementById('surface')?.value) || 0;
            const interestRateInput = parseFloat(document.getElementById('interest-rate')?.value) || 3.3;
            const interestRate = interestRateInput / 100;
            const worksPrice = 0; // simplifié ici pour étape 2
            const totalToFinance = purchasePrice + worksPrice;

            // Calcul mensualité
            const monthlyPayment = calculateMonthlyPayment(totalToFinance, 20, interestRate); // durée par défaut 20 ans
            document.getElementById('monthly-payment').value = Math.round(monthlyPayment).toLocaleString('fr-FR');
        }

        function calculateCashflowData() {
            const purchasePrice = parseFloat(document.getElementById('purchase-price')?.value) || 0;
            const rentBase = parseFloat(document.getElementById('rent-price')?.value) || 1200;
            const charges = parseFloat(document.getElementById('charges')?.value) || 300;

            const interestRateInput = parseFloat(document.getElementById('interest-rate')?.value) || 3.3;
            const interestRate = interestRateInput / 100;
            const totalAmountToFinance = purchasePrice;
            const monthlyPayment = calculateMonthlyPayment(totalAmountToFinance, 20, interestRate);

            const rentPrice = rentBase; // simplifié
            const cashflowNet = rentPrice - charges - monthlyPayment;

            document.getElementById('cashflow-result').textContent = (cashflowNet > 0 ? '+' : '') + Math.round(cashflowNet).toLocaleString('fr-FR') + ' €';
        }

        function initializeEventListeners() {
            ['purchase-price', 'surface', 'interest-rate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculateGeneralPropertyData);
            });

            ['rent-price', 'charges', 'purchase-price', 'interest-rate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculateCashflowData);
            });
        }

        initializeEventListeners();
    </script>
</body>
</html>
