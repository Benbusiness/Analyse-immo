<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Rentabilité Immobilière</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        
        .card-gradient {
            background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }
        
        .risk-low {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #10b981;
        }
        
        .risk-medium {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
        
        .risk-high {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-left: 4px solid #ef4444;
        }
        
        .strategy-card {
            transition: all 0.3s ease;
        }
        
        .strategy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        }
        
        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2) !important;
            border-color: #10b981 !important;
        }
        
        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .badge-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .badge-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .nav-pill {
            transition: all 0.3s ease;
        }
        
        .nav-pill.active {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }
        
        .nav-pill:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            color: white;
        }
        
        canvas {
            border-radius: 12px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50">
    <header class="gradient-bg py-8 px-6 shadow-2xl">
        <div class="container mx-auto max-w-7xl">
            <h1 class="text-4xl md:text-5xl font-bold text-white text-center mb-3">
                <i class="fas fa-chart-line text-emerald-400 mr-3"></i>
                Analyse Rentabilité Immobilière
            </h1>
            <p class="text-slate-300 text-center text-lg md:text-xl">
                Vérifiez si votre projet immobilier est rentable avant de faire une offre
            </p>
        </div>
    </header>

    <main class="container mx-auto max-w-7xl px-4 py-10">
        <!-- Step 1: Strategy Selection -->
        <section id="strategy-section" class="mb-12 animate-fade-in">
            <h2 class="text-3xl font-semibold text-slate-800 mb-6 pb-3 border-b-4 border-emerald-500 inline-block">
                <i class="fas fa-map-marked-alt text-emerald-600 mr-2"></i>
                Étape 1 : Choisissez votre stratégie
            </h2>
            
            <p class="text-slate-700 mb-8 text-lg leading-relaxed">
                Sélectionnez la stratégie immobilière qui correspond à votre projet pour accéder à l'analyse adaptée.
            </p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="strategy-card card-gradient rounded-2xl p-7 border-2 border-slate-200 shadow-xl cursor-pointer" 
                     data-strategy="cashflow">
                    <div class="flex items-center mb-4">
                        <span class="text-5xl bg-gradient-to-br from-emerald-500 to-cyan-500 bg-clip-text text-transparent">
                            <i class="fas fa-building-circle-check"></i>
                        </span>
                        <h3 class="text-3xl font-bold text-slate-700 ml-3">Cash-Flow (Location)</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <i class="fas fa-info-circle text-emerald-500 mr-2"></i>
                        Investissement avec revenu régulier via la location, idéal pour les revenus complémentaires à long terme.
                    </p>
                    <ul class="text-slate-700 mb-6 space-y-2">
                        <li class="flex items-center"><i class="fas fa-check-circle text-emerald-500 mr-2"></i> Calcul du cash-flow mensuel</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-emerald-500 mr-2"></i> Rendement net (%) par an</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-emerald-500 mr-2"></i> Analyse des charges</li>
                    </ul>
                    <button class="btn-primary w-full text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2">
                        Analyser la location <i class="fas fa-calculator"></i>
                    </button>
                </div>
                
                <div class="strategy-card card-gradient rounded-2xl p-7 border-2 border-blue-200 shadow-xl cursor-pointer" 
                     data-strategy="resale">
                    <div class="flex items-center mb-4">
                        <span class="text-5xl bg-gradient-to-br from-blue-500 to-indigo-500 bg-clip-text text-transparent">
                            <i class="fas fa-arrow-trend-up"></i>
                        </span>
                        <h3 class="text-3xl font-bold text-slate-700 ml-3">Achat-Revente</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-4">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i> Investissement à court/moyen terme basé sur la plus-value, 
                        idéal pour les investisseurs chercheurs de rendement rapide.
                    </p>
                    <ul class="text-slate-700 mb-6 space-y-2">
                        <li class="flex items-center"><i class="fas fa-check-circle text-blue-500 mr-2"></i> Projection plus-value nette</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-blue-500 mr-2"></i> Analyse risques / rendement</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-blue-500 mr-2"></i> Optimisation timing revente</li>
                    </ul>
                    <button class="btn-secondary w-full text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2">
                        Analyser l'achat-revente <i class="fas fa-balance-scale"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Step 2: General Property Details -->
        <section id="general-property-section" class="mb-12" style="display: none;">
            <h2 class="text-3xl font-semibold text-slate-800 mb-6 pb-3 border-b-4 border-indigo-500 inline-block">
                <i class="fas fa-home text-indigo-600 mr-2"></i>
                Étape 2 : Détails du bien
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Champs à saisir -->
                <div class="bg-gradient-to-br from-white to-slate-50 p-7 rounded-2xl shadow-xl border-2 border-slate-200">
                    <h3 class="text-xl font-semibold text-slate-700 mb-5 flex items-center">
                        <i class="fas fa-edit text-indigo-600 mr-2"></i> Champs à saisir
                    </h3>
                    
                    <div class="space-y-5">
                        <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                            <label class="block text-slate-700 font-semibold mb-2">
                                <i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Ville / Zone
                            </label>
                            <div class="relative">
                                <input type="text" id="city-zone" placeholder="Saisissez une ville (ex: Paris, Lyon, Marseille)..." 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-300">
                                <div id="city-dropdown" class="absolute z-10 w-full mt-1 bg-white border-2 border-slate-300 rounded-xl shadow-2xl max-h-60 overflow-y-auto"></div>
                            </div>
                            <p class="text-slate-500 text-sm mt-2">
                                <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                                La ville influence le prix au m² et les taxes locales. Sélectionnez une ville dans la liste.
                            </p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-building text-blue-500 mr-2"></i> Type de bien
                                </label>
                                <select id="property-type" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-300">
                                    <option value="">Sélectionner</option>
                                    <option value="appartement" selected>Appartement</option>
                                    <option value="maison">Maison</option>
                                </select>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-hammer text-orange-500 mr-2"></i> État du bien
                                </label>
                                <select id="property-state" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-orange-300">
                                    <option value="">Sélectionner</option>
                                    <option value="ancien" selected>Ancien</option>
                                    <option value="neuf">Neuf</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-ruler-combined text-purple-500 mr-2"></i> Surface (m²)
                                </label>
                                <input type="number" id="surface" value="60" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-300">
                                <p class="text-slate-500 text-sm mt-2">
                                    <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                                    Surface habitable en m²
                                </p>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-euro-sign text-emerald-500 mr-2"></i> Prix d'achat (€)
                                </label>
                                <input type="number" id="purchase-price" value="300000" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-300">
                            </div>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                            <label class="block text-slate-700 font-semibold mb-2">
                                <i class="fas fa-tools text-cyan-500 mr-2"></i> Travaux
                            </label>
                            <select id="works" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-cyan-300 mb-2">
                                <option value="aucun">Aucun</option>
                                <option value="raffraichissement">Raffraichissement</option>
                                <option value="renovation" selected>Rénovation</option>
                                <option value="rehabilitation">Réhabilitation</option>
                                <option value="custom">Montant exact</option>
                            </select>
                            <div id="works-description" class="mt-2 flex items-start gap-2 text-xs text-slate-600">
                                <i class="fas fa-circle-info text-cyan-600 mt-0.5"></i>
                                <span>—</span>
                            </div>
                            <input type="number" id="works-price" value="15000" placeholder="Montant des travaux en €" 
                                   class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-300">
                            <p class="text-slate-500 text-sm mt-2">
                                <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                                Travaux énergétiques ou rénovation
                            </p>
                        </div>
                        
                        <div id="dpe-section" class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-leaf text-yellow-600 mr-2"></i> DPE actuel
                                </label>
                                <select id="dpe-current" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D" selected>D</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="G">G</option>
                                </select>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-solar-panel text-green-600 mr-2"></i> DPE estimé après travaux
                                </label>
                                <select id="dpe-future" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C" selected>C</option>
                                    <option value="D">D</option>
                                    <option value="E">E</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Estimations en temps réel -->
                <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-7 rounded-2xl shadow-xl border-2 border-blue-200">
                    <h3 class="text-xl font-semibold text-slate-700 mb-5 flex items-center">
                        <i class="fas fa-calculator text-blue-600 mr-2"></i> Estimations en temps réel
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-700 font-semibold"><i class="fas fa-chart-line mr-2"></i>Prix moyen au m² dans la zone :</span>
                                <span id="price-per-m2" class="text-xl font-bold text-blue-600">—</span>
                            </div>
                            <p id="price-per-m2-source" class="text-xs text-slate-600 mt-1">
                                <span class="inline-flex items-center gap-2">
                                    <span id="price-per-m2-status" class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">En attente</span>
                                    <span id="price-per-m2-meta">Source : DVF (Etalab) • Période : 2026</span>
                                </span>
                            </p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-700 font-semibold"><i class="fas fa-balance-scale mr-2"></i>Comparatif prix du bien vs marché :</span>
                                <span id="price-comparison" class="text-xl font-bold text-yellow-600">✓ Au prix du marché</span>
                            </div>
                            <p class="text-xs text-slate-600 mt-1">= Prix moyen au m² × Surface</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-700 font-semibold"><i class="fas fa-landmark mr-2"></i>Taxe foncière estimée :</span>
                                <span id="property-tax-est" class="text-xl font-bold text-indigo-600">1,200 €/an</span>
                            </div>
                            <p class="text-xs text-slate-600 mt-1">Basée sur la surface et l'ancienneté du bien</p>
                        </div>
                        
                        <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-700 font-semibold"><i class="fas fa-stamp mr-2"></i>Frais de notaire :</span>
                                <span id="notary-fees" class="text-xl font-bold text-orange-600">24,000 €</span>
                            </div>
                            <p class="text-xs text-slate-600 mt-1">8% du prix d'achat pour ancien, 2-3% pour neuf</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bouton analyser -->
            <div class="text-center mt-8">
                <button id="analyze-general-btn" class="bg-gradient-to-r from-indigo-600 to-blue-700 hover:from-blue-700 hover:to-indigo-600 text-white text-2xl font-semibold py-4 px-12 rounded-xl shadow-2xl transition-all">
                    <i class="fas fa-calculator mr-3"></i> CONFIGUREZ VOTRE INVESTISSEMENT
                </button>
            </div>
        </section>
        
        <!-- Step 3: Strategy-Specific Analysis -->
        <section id="property-section" class="mb-12" style="display: none;">
            <!-- CASH-FLOW SECTION -->
            <div id="cashflow-section" class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-2xl p-8 shadow-xl border-2 border-emerald-200">
                <h2 class="text-3xl font-semibold text-slate-800 mb-6 pb-3 border-b-4 border-emerald-500 inline-block">
                    <i class="fas fa-sack-dollar text-emerald-600 mr-2"></i>
                    Étape 3 : Cash-Flow / Location
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Champs à saisir -->
                    <div>
                        <h3 class="text-xl font-semibold text-slate-700 mb-5 flex items-center">
                            <i class="fas fa-edit text-emerald-600 mr-2"></i> Champs à saisir
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-euro-sign text-emerald-500 mr-2"></i> Loyer mensuel estimé (€)
                                </label>
                                <input type="number" id="rent-price" value="1200" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-300">
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-money-bill-wave text-blue-500 mr-2"></i> Charges mensuelles (€)
                                </label>
                                <input type="number" id="charges" value="300" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-300">
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-home text-purple-500 mr-2"></i> Type de location
                                </label>
                                <select id="rent-type" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-300">
                                    <option>Vide</option>
                                    <option>Meublé</option>
                                    <option>Courte durée</option>
                                </select>
                                <p id="rent-type-help" class="text-xs text-slate-600 mt-2 flex items-start gap-2">
                                    <i class="fas fa-circle-info text-purple-600 mt-0.5"></i>
                                    <span>—</span>
                                </p>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-calendar text-orange-500 mr-2"></i> Durée du crédit (ans)
                                </label>
                                <input type="number" id="loan-term" value="20" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-orange-300">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Champs calculés automatiquement -->
                    <div>
                        <h3 class="text-xl font-semibold text-slate-700 mb-5 flex items-center">
                            <i class="fas fa-calculator text-indigo-600 mr-2"></i> Calculs automatiques
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-emerald-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-700 font-semibold"><i class="fas fa-stamp mr-2"></i>Frais de notaire :</span>
                                    <span id="cf-notary-fees" class="text-xl font-bold text-orange-600">24,000 €</span>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-emerald-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas a-percent text-emerald-500 mr-2"></i> Taux du crédit (%)
                                </label>
                                <div class="flex items-center gap-3">
                                    <!-- Taux moyen des nouveaux crédits immobiliers à l'habitat en 2026 (Banque de France) -->
                                    <input type="number" id="interest-rate" value="3.30" step="0.01"
                                           class="flex-1 px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-300">
                                    <span class="text-sm text-slate-500 font-semibold whitespace-nowrap">Banque de France 2026</span>
                                </div>
                                <p class="text-xs text-slate-600 mt-2">
                                    <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                                    Taux moyen des nouveaux crédits immobiliers à l'habitat en 2026 (source : Banque de France).
                                </p>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-emerald-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-700 font-semibold"><i class="fas fa-landmark mr-2"></i>Taxe foncière :</span>
                                    <span id="cf-property-tax" class="text-xl font-bold text-slate-700">1,200 €/an</span>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-emerald-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-700 font-semibold"><i class="fas fa-credit-card mr-2"></i>Mensualité crédit :</span>
                                    <span id="monthly-payment" class="text-xl font-bold text-blue-600">1,400 €</span>
                                </div>
                                <p id="monthly-payment-detail" class="text-xs text-slate-600 mt-1">= (Prix d'achat + Travaux + Frais de notaire) × Taux mensuel sur la durée du crédit</p>
                            </div>
                            

                            
                            <div class="bg-gradient-to-br from-blue-100 to-indigo-100 p-5 rounded-xl shadow-md border-2 border-blue-400">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-800 font-bold text-lg"><i class="fas fa-percent mr-2"></i>Rendement net :</span>
                                    <span id="yield-net" class="text-2xl font-extrabold text-blue-700">3.2 %</span>
                                </div>
                                <p class="text-xs text-slate-600 mt-1">Cash-flow annuel / Investissement total</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bouton analyser -->
                <div class="text-center">
                    <button id="analyze-cashflow-btn" class="btn-primary text-white text-2xl font-semibold py-4 px-12 rounded-xl shadow-2xl">
                        <i class="fas fa-brain mr-3"></i> ANALYSER LE PROJET
                    </button>
                </div>
            </div>
            
            <!-- RESALE SECTION -->
            <div id="resale-section" class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8 shadow-xl border-2 border-blue-200" style="display: none;">
                <h2 class="text-3xl font-semibold text-slate-800 mb-6 pb-3 border-b-4 border-blue-500 inline-block">
                    <i class="fas fa-arrow-trend-up text-blue-600 mr-2"></i>
                    Étape 3 : Achat-Revente
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Champs à saisir -->
                    <div>
                        <h3 class="text-xl font-semibold text-slate-700 mb-5 flex items-center">
                            <i class="fas fa-edit text-blue-600 mr-2"></i> Champs à saisir
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-handshake text-blue-500 mr-2"></i> Mode de revente
                                </label>
                                <select id="resale-mode" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-300">
                                    <option>Agence</option>
                                    <option>Direct</option>
                                </select>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-clock text-orange-500 mr-2"></i> Durée avant revente (ans)
                                </label>
                                <select id="resale-duration" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-orange-300">
                                    <option>1</option>
                                    <option selected>2</option>
                                    <option>5</option>
                                    <option>10</option>
                                </select>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-euro-sign text-emerald-500 mr-2"></i> Prix achat (€)
                                </label>
                                <input type="number" id="rs-purchase-price" value="300000" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-emerald-300">
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                <label class="block text-slate-700 font-semibold mb-2">
                                    <i class="fas fa-tools text-purple-500 mr-2"></i> Travaux
                                </label>
                                <select id="rs-works" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl focus:ring-2 focus:ring-purple-300 mb-2">
                                    <option value="aucun">Aucun</option>
                                    <option value="raffraichissement">Raffraichissement</option>
                                    <option value="renovation">Rénovation</option>
                                    <option value="rehabilitation">Réhabilitation</option>
                                    <option value="custom">Montant exact</option>
                                </select>
                                <div id="rs-works-description" class="mt-2 flex items-start gap-2 text-xs text-slate-600" style="display:none;">
                                    <i class="fas fa-circle-info text-purple-600 mt-0.5"></i>
                                    <span>—</span>
                                </div>
                                <input type="number" id="rs-works-price" value="15000" placeholder="Montant des travaux" 
                                       class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                    <label class="block text-slate-700 font-semibold mb-2">
                                        <i class="fas fa-leaf text-yellow-600 mr-2"></i> DPE actuel
                                    </label>
                                    <select id="rs-dpe-current" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl">
                                        <option>A</option>
                                        <option>B</option>
                                        <option>C</option>
                                        <option selected>D</option>
                                        <option>E</option>
                                        <option>F</option>
                                        <option>G</option>
                                    </select>
                                </div>
                                
                                <div class="bg-white p-5 rounded-xl shadow-md border border-slate-200">
                                    <label class="block text-slate-700 font-semibold mb-2">
                                        <i class="fas fa-solar-panel text-green-600 mr-2"></i> DPE après
                                    </label>
                                    <select id="rs-dpe-future" class="w-full px-4 py-3 border-2 border-slate-300 rounded-xl">
                                        <option>A</option>
                                        <option>B</option>
                                        <option selected>C</option>
                                        <option>D</option>
                                        <option>E</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Projections et calculs -->
                    <div>
                        <h3 class="text-xl font-semibold text-slate-700 mb-5 flex items-center">
                            <i class="fas fa-calculator text-indigo-600 mr-2"></i> Projections & Calculs
                        </h3>
                        
                        <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-5 rounded-xl border border-blue-200 mb-4">
                            <h4 class="font-semibold text-slate-700 mb-3">
                                <i class="fas fa-bullseye text-indigo-600 mr-2"></i> Projection de revente
                            </h4>
                            <div class="grid grid-cols-3 gap-2">
                                <button class="projection-btn bg-gradient-to-br from-red-400 to-pink-500 text-white font-semibold py-2 px-3 rounded-lg transition-all" data-projection="low">
                                    Basse
                                </button>
                                <button class="projection-btn active bg-gradient-to-br from-amber-400 to-yellow-500 text-white font-semibold py-2 px-3 rounded-lg transition-all" data-projection="realistic">
                                    Réaliste
                                </button>
                                <button class="projection-btn bg-gradient-to-br from-emerald-500 to-teal-600 text-white font-semibold py-2 px-3 rounded-lg transition-all" data-projection="high">
                                    Haute
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-700 font-semibold"><i class="fas fa-chart-line mr-2"></i>Prix revente estimé :</span>
                                    <span id="resale-price-est" class="text-xl font-bold text-blue-600">330,000 €</span>
                                </div>
                                <p class="text-xs text-slate-600 mt-1">Prix achat + évolution prix au m²</p>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-700 font-semibold"><i class="fas fa-building mr-2"></i>Frais d'agence :</span>
                                    <span id="agency-fees" class="text-xl font-bold text-orange-600">16,500 €</span>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-xl shadow-md border border-blue-200">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-700 font-semibold"><i class="fas fa-receipt mr-2"></i>Taxes + prélèvements :</span>
                                    <span id="capital-gains-tax" class="text-xl font-bold text-red-600">4,050 €</span>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-emerald-100 to-teal-100 p-5 rounded-xl shadow-md border-2 border-emerald-400">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-800 font-bold text-lg"><i class="fas fa-coins mr-2"></i>Plus-value nette :</span>
                                    <span id="net-capital-gain" class="text-2xl font-extrabold text-emerald-700">-5,550 €</span>
                                </div>
                                <p class="text-xs text-slate-600 mt-1">Prix revente - (Prix achat + Travaux + frais + taxes)</p>
                            </div>
                            
                            <div class="bg-gradient-to-br from-blue-100 to-indigo-100 p-5 rounded-xl shadow-md border-2 border-blue-400">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-slate-800 font-bold text-lg"><i class="fas fa-percent mr-2"></i>Rendement net global :</span>
                                    <span id="global-yield" class="text-2xl font-extrabold text-blue-700">-1.7 %</span>
                                </div>
                                <p class="text-xs text-slate-600 mt-1">Plus-value nette / Investissement total</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bouton analyser -->
                <div class="text-center">
                    <button id="analyze-resale-btn" class="btn-secondary text-white text-2xl font-semibold py-4 px-12 rounded-xl shadow-2xl">
                        <i class="fas fa-brain mr-3"></i> ANALYSER LE PROJET
                    </button>
                </div>
            </div>
        </section>

        
        <!-- Results Section -->
        <section id="results-section" class="mb-12 bg-gradient-to-br from-slate-50 to-white rounded-2xl p-8 shadow-xl border-2 border-slate-200">
            <h2 class="text-3xl font-semibold text-slate-800 mb-6 pb-3 border-b-4 border-indigo-500 inline-block">
                <i class="fas fa-chart-pie text-indigo-600 mr-2"></i>
                Résultats de l'analyse
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                <!-- Key Metrics Cards -->
                <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-7 rounded-2xl border-3 border-emerald-300 shadow-lg">
                    <h4 class="text-lg font-semibold text-slate-700 mb-2 flex items-center">
                        <i class="fas fa-hand-holding-dollar text-emerald-700 mr-2"></i> Cash-Flow mensuel
                    </h4>
                    <p id="cashflow-result" class="text-5xl font-extrabold text-emerald-700">+400 €</p>
                    <p class="text-slate-600 text-sm mt-2">Net après charges et mensualités</p>
                </div>
                
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-7 rounded-2xl border-3 border-blue-300 shadow-lg">
                    <h4 class="text-lg font-semibold text-slate-700 mb-2 flex items-center">
                        <i class="fas fa-percent text-blue-700 mr-2"></i> Rendement net
                    </h4>
                    <p id="yield-result" class="text-5xl font-extrabold text-blue-700">4.8 %</p>
                    <p class="text-slate-600 text-sm mt-2">Pourcentage annuel sur investissement total</p>
                </div>
                
                <div class="bg-gradient-to-br from-orange-50 to-amber-50 p-7 rounded-2xl border-3 border-orange-300 shadow-lg">
                    <h4 class="text-lg font-semibold text-slate-700 mb-2 flex items-center">
                        <i class="fas fa-balance-scale-right text-orange-700 mr-2"></i> Risque
                    </h4>
                    <p id="risk-level" class="text-5xl font-extrabold text-orange-700">Modéré</p>
                    <p class="text-slate-600 text-sm mt-2">Analyse de la rentabilité et des risques</p>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-blue-600 mr-2"></i> Distribution des coûts
                    </h3>
                    <canvas id="cost-chart" height="250"></canvas>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4 flex items-center">
                        <i class="fas fa-arrow-trend-up text-emerald-600 mr-2"></i> Évolution du rendement
                    </h3>
                    <canvas id="trend-chart" height="250"></canvas>
                </div>
            </div>
            
            <!-- Global Evaluation -->
            <div id="evaluation" class="risk-medium p-6 rounded-xl mb-8">
                <h3 class="text-2xl font-semibold text-amber-800 mb-3">
                    <i class="fas fa-lightbulb mr-2"></i> Évaluation globale
                </h3>
                <p class="text-lg text-amber-900 leading-relaxed">
                    <strong>Affaire peu rentable</strong> : Le rendement est légèrement au dessous des standards du marché. 
                    Optimisez le prix d'achat ou le loyer pour améliorer la rentabilité.
                </p>
            </div>
            
            <!-- Optimization Tips -->
            <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-7 rounded-2xl border-2 border-slate-300 mb-8">
                <h3 class="text-2xl font-semibold text-slate-700 mb-4 flex items-center">
                    <i class="fas fa-lightbulb text-orange-500 mr-2"></i> Conseils d'optimisation
                </h3>
                <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <li class="flex items-start gap-2 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <i class="fas fa-arrow-down text-green-600 text-xl mt-1"></i>
                        <span class="font-semibold text-slate-700">Réduisez le prix d'achat</span><br>
                        <span class="text-sm text-slate-600">Une baisse de 5% améliorerait le rendement de +1,2%</span>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <i class="fas fa-bed text-blue-600 text-xl mt-1"></i>
                        <span class="font-semibold text-slate-700">Optimisez la location</span><br>
                        <span class="text-sm text-slate-600">Location meublée +15% de revenu vs location vide</span>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <i class="fas fa-tools text-purple-600 text-xl mt-1"></i>
                        <span class="font-semibold text-slate-700">Travaux énergétiques</span><br>
                        <span class="text-sm text-slate-600">Améliorer le DPE réduira les charges de chauffage</span>
                    </li>
                    <li class="flex items-start gap-2 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <i class="fas fa-money-check text-cyan-600 text-xl mt-1"></i>
                        <span class="font-semibold text-slate-700">Ajustez le crédit</span><br>
                        <span class="text-sm text-slate-600">Une durée de 25 ans réduira les mensualités de -12%</span>
                    </li>
                </ul>
            </div>
            
            <!-- Final Synthesis -->
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-7 rounded-2xl border-2 border-orange-300">
                <h3 class="text-2xl font-semibold text-orange-700 mb-4 flex items-center">
                    <i class="fas fa-file-invoice text-orange-500 mr-2"></i> Synthèse complète
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-200">
                        <p class="text-lg font-semibold text-slate-700">Investissement total</p>
                        <p id="total-investment" class="text-3xl font-bold text-orange-700">339,000 €</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-emerald-200">
                        <p class="text-lg font-semibold text-slate-700">Cash-flow annuel net</p>
                        <p id="annual-cashflow" class="text-3xl font-bold text-emerald-700">4,800 €</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-200">
                        <p class="text-lg font-semibold text-slate-700">Rendement net global</p>
                        <p id="total-yield" class="text-3xl font-bold text-blue-700">4.8 %</p>
                    </div>
                </div>
                
                <!-- Verdict -->
                <div class="text-center mt-6">
                    <h4 class="text-xl font-semibold text-slate-700 mb-3">Verdict</h4>
                    <button id="verdict-btn" class="bg-gradient-to-r from-amber-600 to-orange-700 hover:from-orange-700 hover:to-amber-600 text-white font-semibold py-3 px-10 rounded-xl transition-all text-lg">
                        <i class="fas fa-exclamation-triangle mr-2"></i> OPTIMISER L'OFFRE
                    </button>
                </div>
                
                <!-- Export Buttons -->
                <div class="flex flex-wrap gap-4 justify-center mt-6">
                    <button id="pdf-export" class="bg-gradient-to-r from-pink-500 to-rose-600 hover:from-rose-600 hover:to-pink-500 text-white font-semibold py-3 px-6 rounded-xl flex items-center gap-2 transition-all">
                        <i class="fas fa-file-pdf"></i> Exporter en PDF
                    </button>
                    <button id="excel-export" class="bg-gradient-to-r from-emerald-500 to-green-700 hover:from-green-700 hover:to-emerald-500 text-white font-semibold py-3 px-6 rounded-xl flex items-center gap-2 transition-all">
                        <i class="fas fa-file-excel"></i> Exporter en Excel
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Advanced Search / Additional Details -->
        <section class="mb-10 bg-gradient-to-r from-slate-50 to-slate-100 rounded-2xl p-8 border-2 border-slate-300">
            <h2 class="text-2xl font-semibold text-slate-700 mb-6 pb-2 border-b-2 border-slate-400 flex items-center">
                <i class="fas fa-sliders text-slate-600 mr-2"></i>
                Recherche avancée (Optionnelle)
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-semibold text-slate-700 mb-3 text-lg">Crédit exact</h4>
                    <div class="space-y-3">
                        <label class="block text-sm text-slate-600 font-semibold">Taux d'intérêt (%)</label>
                        <input type="number" id="interest-rate-advanced" value="3.5" step="0.1" 
                               class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-300">
                        <p class="text-xs text-slate-500">Optionnel : si renseigné, ce taux peut remplacer le taux Banque de France de l’étape Cash-Flow.</p>
                    </div>
                </div>
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-semibold text-slate-700 mb-3 text-lg">État du bien</h4>
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="occupied" class="w-5 h-5 text-blue-600 bg-slate-100">
                        <label class="text-slate-700 font-semibold" for="occupied">Bien occupé</label>
                    </div>
                </div>
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-semibold text-slate-700 mb-3 text-lg">Assurances & Frais</h4>
                    <input type="number" id="insurance" value="300" 
                           class="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-300"
                           placeholder="Frais annuels">
                </div>
            </div>
        </section>
        
        <!-- Footer / Navigation -->
        <section class="text-center mb-8 pb-6 border-t-4 border-slate-300 pt-8">
            <p class="text-slate-700 text-lg">
                Cette analyse est fournie à titre informatif. Pour des conseils personnalisés, consultez un conseiller immobilier ou financier.
            </p>
            <p class="text-slate-500 text-sm mt-3">
                <i class="fas fa-code-branch"></i> Application web responsive optimisée pour desktop et mobile
            </p>
        </section>
    </main>
    
    <footer class="gradient-bg text-white py-8">
        <div class="container mx-auto max-w-7xl px-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="text-center md:text-left">
                    <h3 class="text-2xl font-semibold text-emerald-400 mb-2">
                        <i class="fas fa-home-heart mr-2"></i> Analyse Immo
                    </h3>
                    <p class="text-slate-300 text-sm max-w-md">
                        Optimisez vos investissements immobiliers grâce à des outils d'analyse performants et précis.
                    </p>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4">
                    <span class="text-slate-300 text-sm flex items-center gap-2">
                        <i class="fas fa-calculator text-emerald-400"></i> Calculs automatiques
                    </span>
                    <span class="text-slate-300 text-sm flex items-center gap-2">
                        <i class="fas fa-shield-halved text-blue-400"></i> Sécurité des données
                    </span>
                    <span class="text-slate-300 text-sm flex items-center gap-2">
                        <i class="fas fa-bullseye text-purple-400"></i> Accurate projections
                    </span>
                </div>
            </div>
            
            <div class="border-t border-slate-700 mt-6 pt-6 text-center">
                <p class="text-slate-300 text-sm">&copy; 2025 Analyse Immo. Tous droits réservés.</p>
            </div>
        </div>
    </footer>
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        // Global variables
        let selectedStrategy = 'cashflow';
        let projectionType = 'realistic';

        // Helpers
        function normalizeText(str) {
            return (str || '')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase()
                .trim();
        }
        
        // French cities and their average property prices per m² (as of 2024 - realistic values)
        const frenchCities = [
            { name: 'Paris', price: 12000 },
            { name: 'Marseille', price: 4500 },
            { name: 'Lyon', price: 6500 },
            { name: 'Toulouse', price: 4000 },
            { name: 'Nice', price: 6800 },
            { name: 'Nantes', price: 4500 },
            { name: 'Strasbourg', price: 5200 },
            { name: 'Montpellier', price: 4300 },
            { name: 'Bordeaux', price: 5500 },
            { name: 'Lille', price: 4500 },
            { name: 'Rennes', price: 4200 },
            { name: 'Reims', price: 3800 },
            { name: 'Le Havre', price: 3200 },
            { name: 'Saint-Étienne', price: 2800 },
            { name: 'Toulon', price: 4100 },
            { name: 'Grenoble', price: 4000 },
            { name: 'Dijon', price: 3600 },
            { name: 'Angers', price: 3500 },
            { name: 'Nîmes', price: 3400 },
            { name: 'Villeurbanne', price: 5800 },
            { name: 'Clermont-Ferrand', price: 3100 },
            { name: 'Aix-en-Provence', price: 5000 },
            { name: 'Brest', price: 3000 },
            { name: 'Le Mans', price: 3000 },
            { name: 'Tours', price: 3300 },
            { name: 'Amiens', price: 2900 },
            { name: 'Limoges', price: 2600 },
            { name: 'Annecy', price: 6000 },
            { name: 'Boulogne-Billancourt', price: 11000 },
            { name: 'Montreuil', price: 8000 },
            { name: 'Saint-Denis', price: 7500 },
            { name: 'Nanterre', price: 7000 },
            { name: 'Versailles', price: 7200 },
            { name: 'Cannes', price: 9500 },
            { name: 'Antibes', price: 7800 },
            { name: 'Rouen', price: 3800 },
            { name: 'Grasse', price: 7000 },
            { name: 'Beaulieu-sur-Mer', price: 15000 },
            { name: 'Saint-Tropez', price: 18000 },
            { name: 'Menton', price: 8500 },
            { name: 'Cannes-la-Bocca', price: 6500 },
            { name: 'Deauville', price: 9000 },
            { name: 'Trouville-sur-Mer', price: 8000 },
            { name: 'Saint-Jean-Cap-Ferrat', price: 20000 },
            { name: 'Èze', price: 12000 },
            { name: 'La Baule-Escoublac', price: 6000 },
            { name: 'Arcachon', price: 7500 },
            { name: 'Agen', price: 2100 },
            { name: 'Ajaccio', price: 5200 },
            { name: 'Albi', price: 2200 },
            { name: 'Alençon', price: 1700 },
            { name: 'Aix-les-Bains', price: 4600 },
            { name: 'Angoulême', price: 1900 },
            { name: 'Annecy-le-Vieux', price: 6400 },
            { name: 'Antony', price: 6600 },
            { name: 'Arles', price: 2700 },
            { name: 'Arras', price: 2800 },
            { name: 'Aurillac', price: 1600 },
            { name: 'Auxerre', price: 2000 },
            { name: 'Avignon', price: 2900 },
            { name: 'Bagnères-de-Bigorre', price: 1900 },
            { name: 'Bayonne', price: 5200 },
            { name: 'Belfort', price: 1800 },
            { name: 'Besançon', price: 2600 },
            { name: 'Béziers', price: 2400 },
            { name: 'Blois', price: 2300 },
            { name: 'Bourges', price: 1900 },
            { name: 'Brive-la-Gaillarde', price: 2100 },
            { name: 'Biarritz', price: 8000 },
            { name: 'Caen', price: 3100 },
            { name: 'Calais', price: 1900 },
            { name: 'Carcassonne', price: 1700 },
            { name: 'Cergy', price: 3700 },
            { name: 'Chambéry', price: 3400 },
            { name: 'Champigny-sur-Marne', price: 4300 },
            { name: 'Charleville-Mézières', price: 1500 },
            { name: 'Chartres', price: 2600 },
            { name: 'Châteauroux', price: 1500 },
            { name: 'Cherbourg-en-Cotentin', price: 2000 },
            { name: 'Cholet', price: 2300 },
            { name: 'Colmar', price: 3200 },
            { name: 'Colombes', price: 6200 },
            { name: 'Compiègne', price: 2500 },
            { name: 'Courbevoie', price: 9000 },
            { name: 'Créteil', price: 4200 },
            { name: 'Dax', price: 2600 },
            { name: 'Draguignan', price: 2800 },
            { name: 'Douai', price: 2900 },
            { name: 'Dunkerque', price: 2100 },
            { name: 'Épernay', price: 2100 },
            { name: 'Épinal', price: 1600 },
            { name: 'Tourcoing', price: 3100 },
            { name: 'Évry', price: 3500 },
            { name: 'Fontainebleau', price: 4700 },
            { name: 'Fréjus', price: 5000 },
            { name: 'Gap', price: 2500 },
            { name: 'Garches', price: 8200 },
            { name: 'Génnevilliers', price: 5200 },
            { name: 'Gonesse', price: 3700 },
            { name: 'Grasse', price: 7000 },
            { name: 'Haguenau', price: 2500 },
            { name: 'Hyères', price: 4700 },
            { name: 'Issy-les-Moulineaux', price: 9500 },
            { name: 'Istres', price: 2600 },
            { name: 'Ivry-sur-Seine', price: 6200 },
            { name: 'La Ciotat', price: 5200 },
            { name: 'La Rochelle', price: 4800 },
            { name: 'La Roche-sur-Yon', price: 2500 },
            { name: 'Lambersart', price: 3600 },
            { name: 'Lannion', price: 2300 },
            { name: 'Le Cannet', price: 5800 },
            { name: 'Le Port-Marly', price: 7200 },
            { name: 'Levallois-Perret', price: 10000 },
            { name: 'Libourne', price: 2800 },
            { name: 'Lorient', price: 2700 },
            { name: 'Lourdes', price: 1500 },
            { name: 'Luxeuil-les-Bains', price: 1700 },
            { name: 'Mâcon', price: 2100 },
            { name: 'Mantes-la-Jolie', price: 3000 },
            { name: 'Metz', price: 3000 },
            { name: 'Meaux', price: 3100 },
            { name: 'Meyzieu', price: 3200 },
            { name: 'Montauban', price: 2200 },
            { name: 'Mulhouse', price: 1900 },
            { name: 'Narbonne', price: 2600 },
            { name: 'Nevers', price: 1600 },
            { name: 'Niort', price: 2400 },
            { name: 'Pau', price: 2700 },
            { name: 'Périgueux', price: 1900 },
            { name: 'Perpignan', price: 2000 },
            { name: 'Poitiers', price: 2300 },
            { name: 'Quimper', price: 2600 },
            { name: 'Rodez', price: 2000 },
            { name: 'Saint-Brieuc', price: 2300 },
            { name: 'Saint-Malo', price: 5400 },
            { name: 'Saint-Nazaire', price: 2600 },
            { name: 'Saint-Ouen', price: 6900 },
            { name: 'Saint-Quentin', price: 1700 },
            { name: 'Sète', price: 3800 },
            { name: 'Tarbes', price: 1700 },
            { name: 'Thionville', price: 2700 },
            { name: 'Troyes', price: 2000 },
            { name: 'Valence', price: 2600 },
            { name: 'Valserhône', price: 2400 },
            { name: 'Vannes', price: 3600 },
            { name: 'Vichy', price: 1800 },
            { name: 'Vienne', price: 2600 },
            { name: 'Vitré', price: 2300 },
            { name: 'Vitry-sur-Seine', price: 5900 },
            { name: 'Wattignies', price: 3300 },
            { name: 'Neydens', price: 5200 },
            { name: 'Thonon-les-Bains', price: 4600 },
            { name: 'Annemasse', price: 4200 },
            { name: 'Gaillard', price: 4500 },
            { name: 'Archamps', price: 5600 },
            { name: 'Ville-la-Grand', price: 4100 },
            { name: 'Saint-Julien-en-Genevois', price: 5300 },
            { name: 'Ferney-Voltaire', price: 6000 },
            { name: 'Divonne-les-Bains', price: 7200 },
            { name: 'Gex', price: 4800 },
            { name: 'Meyrin', price: 7000 },
            { name: 'Passy', price: 4200 },
            { name: 'Sallanches', price: 3900 },
            { name: 'Chamonix-Mont-Blanc', price: 9500 },
            { name: 'Megève', price: 10500 },
            { name: 'Epagny Metz-Tessy', price: 5200 },
            { name: 'Poisy', price: 5000 },
            { name: 'Seynod', price: 4600 },

            // Ajouts demandés / communes courantes
            { name: 'Thoiry', price: 4900 },
            { name: 'Juan-les-Pins', price: 7600 },
            { name: 'Antibes Juan-les-Pins', price: 7800 },
            { name: 'Ferney Voltaire', price: 6000 },
            { name: 'Saint Julien en Genevois', price: 5300 },
            { name: 'Cagnes-sur-Mer', price: 5400 },
            { name: 'Vallauris', price: 5200 },
            { name: 'Mougins', price: 6500 },
            { name: 'Valbonne', price: 5900 },
            { name: 'Biot', price: 6100 },
            { name: 'Saint-Laurent-du-Var', price: 5200 }
        ];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            initializeCharts();
        });
        
        function initializeEventListeners() {
            // City search functionality
            const cityInput = document.getElementById('city-zone');
            const cityDropdown = document.getElementById('city-dropdown');
            
            cityInput.addEventListener('input', function() {
                const searchTerm = normalizeText(this.value);
                // If user hasn't typed anything, don't flood the dropdown
                if (!searchTerm) {
                    cityDropdown.innerHTML = '';
                    return;
                }

                const filteredCities = frenchCities
                    .map(city => ({ city, n: normalizeText(city.name) }))
                    .filter(x => x.n.includes(searchTerm))
                    .sort((a, b) => {
                        const aStarts = a.n.startsWith(searchTerm) ? 0 : 1;
                        const bStarts = b.n.startsWith(searchTerm) ? 0 : 1;
                        if (aStarts !== bStarts) return aStarts - bStarts;
                        return a.city.name.localeCompare(b.city.name, 'fr');
                    })
                    .slice(0, 50)
                    .map(x => x.city);

                displayCityDropdown(filteredCities);
            });
            
            // Click outside to close dropdown
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.relative')) {
                    cityDropdown.innerHTML = '';
                }
            });
            
            // Strategy selection
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.addEventListener('click', function(event) {
                    selectedStrategy = this.dataset.strategy;
                    highlightStrategyCard(card);
                    showGeneralPropertySection();
                    
                    // If a button inside the card is clicked, scroll to step 2 (general property details)
                    if (event.target.closest('button')) {
                        setTimeout(() => {
                            const generalPropertySection = document.getElementById('general-property-section');
                            if (generalPropertySection) {
                                generalPropertySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    }
                });
            });

            // General property inputs real-time calculation
            const idsToWatch = ['property-type', 'property-state', 'surface', 'purchase-price', 'works', 'works-price', 'city-zone'];
            idsToWatch.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    ['input', 'change'].forEach(eventType => {
                        el.addEventListener(eventType, () => {
                            calculateGeneralPropertyData().then(() => {
                                if (selectedStrategy === 'cashflow') calculateCashflowData();
                                if (selectedStrategy === 'resale') calculateResaleData();
                            });
                        });
                    });
                }
            });

            const worksSelect = document.getElementById('works');
            if (worksSelect) {
                // Initial description
                updateWorksDescription(worksSelect.value || 'aucun');

                worksSelect.addEventListener('change', function() {
                    const worksPriceInput = document.getElementById('works-price');
                    if (this.value === 'custom') {
                        worksPriceInput.disabled = false;
                        worksPriceInput.classList.remove('opacity-50');
                    } else {
                        worksPriceInput.disabled = true;
                        worksPriceInput.classList.add('opacity-50');
                        setGeneralWorksPriceByLevel(this.value);
                    }
                    updateWorksDescription(this.value);
                    calculateGeneralPropertyData();
                    if (selectedStrategy === 'cashflow') {
                        calculateCashflowData();
                    }
                });
            }
            
            // Cashflow specific inputs real-time calculation
            const cashflowInputs = ['rent-price', 'charges', 'rent-type', 'loan-term', 'interest-rate'];
            cashflowInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calculateCashflowData);
                    el.addEventListener('change', calculateCashflowData);
                }
            });

            // Rent type helper (1-line explanation with impact)
            const rentTypeEl = document.getElementById('rent-type');
            if (rentTypeEl) {
                updateRentTypeHelp();
                rentTypeEl.addEventListener('change', updateRentTypeHelp);
            }

            // Resale works: auto amount + description
            const rsWorksSelect = document.getElementById('rs-works');
            if (rsWorksSelect) {
                // show description immediately
                const rsWorksDesc = document.getElementById('rs-works-description');
                if (rsWorksDesc) rsWorksDesc.style.display = 'flex';
                updateResaleWorksDescription(rsWorksSelect.value || 'aucun');

                rsWorksSelect.addEventListener('change', function() {
                    const worksPriceInput = document.getElementById('rs-works-price');
                    if (this.value === 'custom') {
                        worksPriceInput.disabled = false;
                        worksPriceInput.classList.remove('opacity-50');
                    } else {
                        worksPriceInput.disabled = true;
                        worksPriceInput.classList.add('opacity-50');
                        setResaleWorksPriceByLevel(this.value);
                    }
                    updateResaleWorksDescription(this.value);
                    calculateResaleData();
                });
            }

            // Resale inputs
            ['resale-mode', 'resale-duration', 'rs-purchase-price', 'rs-works-price', 'rs-dpe-current', 'rs-dpe-future'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateResaleData);
                    element.addEventListener('change', calculateResaleData);
                }
            });

            // Export buttons
            document.getElementById('pdf-export').addEventListener('click', exportToPDF);
            document.getElementById('excel-export').addEventListener('click', exportToExcel);
            
            // General property analyze button
            document.getElementById('analyze-general-btn').addEventListener('click', async function() {
                // Calculate general property details
                await calculateGeneralPropertyData();
                
                // Show strategy-specific section
                showStrategySection(selectedStrategy);
                
                // Scroll to step 3
                setTimeout(() => {
                    const propertySection = document.getElementById('property-section');
                    if (propertySection) {
                        propertySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            });
            
            // Projection selection
            document.querySelectorAll('.projection-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    projectionType = this.dataset.projection;
                    highlightProjectionBtn(this);
                    if (selectedStrategy === 'resale') {
                        calculateResaleData();
                    }
                });
            });
            
            // Analyze buttons for each strategy
            const analyzeCashflowBtn = document.getElementById('analyze-cashflow-btn');
            const analyzeResaleBtn = document.getElementById('analyze-resale-btn');
            
            if (analyzeCashflowBtn) {
                analyzeCashflowBtn.addEventListener('click', analyzeProject);
            }
            if (analyzeResaleBtn) {
                analyzeResaleBtn.addEventListener('click', analyzeProject);
            }
        }
        
        function displayCityDropdown(cities) {
            const dropdown = document.getElementById('city-dropdown');

            if (cities.length === 0) {
                dropdown.innerHTML = '<div class="p-3 text-slate-500 text-sm">Aucune ville correspondante</div>';
                return;
            }

            dropdown.innerHTML = cities.map(city => `
                <div class="city-option p-3 hover:bg-indigo-50 cursor-pointer transition-colors border-b border-slate-100" 
                     data-price="${city.price}" 
                     data-name="${city.name}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-slate-700">${city.name}</span>
                        <span class="text-sm text-indigo-600 font-semibold">${city.price.toLocaleString('fr-FR')} €/m²</span>
                    </div>
                </div>
            `).join('');

            // Add click event to select a city
            dropdown.querySelectorAll('.city-option').forEach(option => {
                option.addEventListener('click', function() {
                    const cityName = this.dataset.name;

                    // Update the input field
                    document.getElementById('city-zone').value = cityName;
                    // Close the dropdown
                    document.getElementById('city-dropdown').innerHTML = '';
                    // Recalculate property data (async)
                    Promise.resolve(calculateGeneralPropertyData());
                });
            });
        }
        
        function highlightStrategyCard(selectedCard) {
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.classList.remove('border-4', 'border-emerald-500', 'border-blue-500', 'shadow-emerald-200', 'shadow-blue-200', 'ring-4', 'ring-emerald-200', 'ring-blue-200');
                card.classList.add('border-2');
                if (card.dataset.strategy === 'cashflow') {
                    card.classList.add('border-slate-200');
                } else {
                    card.classList.add('border-blue-200');
                }
            });
            
            if (selectedCard.dataset.strategy === 'cashflow') {
                selectedCard.classList.remove('border-slate-200');
                selectedCard.classList.add('border-4', 'border-emerald-500', 'ring-4', 'ring-emerald-200');
            } else {
                selectedCard.classList.remove('border-blue-200');
                selectedCard.classList.add('border-4', 'border-blue-500', 'ring-4', 'ring-blue-200');
            }
        }
        
        function highlightProjectionBtn(selectedBtn) {
            document.querySelectorAll('.projection-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            selectedBtn.classList.add('active');
        }
        
        function showGeneralPropertySection() {
            const generalPropertySection = document.getElementById('general-property-section');
            generalPropertySection.style.display = 'block';
            
            // Hide/Show DPE section based on strategy
            const dpeSection = document.getElementById('dpe-section');
            if (dpeSection) {
                if (selectedStrategy === 'cashflow') {
                    dpeSection.style.display = 'none';
                } else {
                    dpeSection.style.display = 'grid';
                }
            }
            
            // Initialize calculations
            calculateGeneralPropertyData();
        }
        
        function showStrategySection(strategy) {
            const propertySection = document.getElementById('property-section');
            const cashflowSection = document.getElementById('cashflow-section');
            const resaleSection = document.getElementById('resale-section');
            
            propertySection.style.display = 'block';
            
            if (strategy === 'cashflow') {
                cashflowSection.style.display = 'block';
                resaleSection.style.display = 'none';
                calculateCashflowData();
                // Ensure rent-type helper is up to date when step 3 becomes visible
                updateRentTypeHelp();
            } else {
                cashflowSection.style.display = 'none';
                resaleSection.style.display = 'block';
                calculateResaleData();
            }
        }
        
        // --- Prix au m² “en vigueur” : tentative via sources publiques (2026) ---
        // Stratégie :
        // 1) On géocode la commune via l’API Adresse (data.gouv.fr)
        // 2) On tente une estimation à partir de DVF (Etalab) sur la période 2026 (si endpoint accessible)
        // 3) Fallback : valeur locale (frenchCities)
        // Note : les APIs publiques peuvent être limitées (CORS / quota). On met en cache.

        const PRICE_CACHE_KEY = 'priceM2Cache_v1';
        const PRICE_TARGET_YEAR = 2026;

        function getPriceCache() {
            try { return JSON.parse(localStorage.getItem(PRICE_CACHE_KEY) || '{}'); } catch { return {}; }
        }
        function setPriceCache(cache) {
            try { localStorage.setItem(PRICE_CACHE_KEY, JSON.stringify(cache)); } catch {}
        }

        function setPriceM2UI({ value, status, meta }) {
            const priceEl = document.getElementById('price-per-m2');
            const statusEl = document.getElementById('price-per-m2-status');
            const metaEl = document.getElementById('price-per-m2-meta');
            if (priceEl) priceEl.textContent = (value && value > 0) ? Math.round(value).toLocaleString('fr-FR') + ' €/m²' : '—';

            if (statusEl) {
                statusEl.textContent = status || '—';
                const s = (status || '').toLowerCase();
                statusEl.className = 'px-2 py-0.5 rounded-full text-slate-600';
                if (s.includes('dvf')) statusEl.className += ' bg-emerald-100 text-emerald-800';
                else if (s.includes('cache')) statusEl.className += ' bg-blue-100 text-blue-800';
                else if (s.includes('fallback')) statusEl.className += ' bg-amber-100 text-amber-800';
                else if (s.includes('charg')) statusEl.className += ' bg-slate-100 text-slate-600';
                else statusEl.className += ' bg-slate-100 text-slate-600';
            }

            if (metaEl) metaEl.textContent = meta || `Source : DVF (Etalab) • Période : ${PRICE_TARGET_YEAR}`;
        }

        function getLocalCityPrice(cityZone) {
            const match = frenchCities.find(c => normalizeText(c.name) === normalizeText(cityZone));
            return match?.price || 5000;
        }

        async function geocodeCity(cityName) {
            // api-adresse : renvoie des communes, on prend le meilleur résultat
            const url = `https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(cityName)}&type=municipality&limit=1`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Geocoding failed');
            const data = await res.json();
            const feat = data?.features?.[0];
            if (!feat) throw new Error('No geocode result');
            const [lon, lat] = feat.geometry.coordinates;
            const props = feat.properties || {};
            return { lat, lon, city: props.city || cityName, citycode: props.citycode, postcode: props.postcode };
        }

        async function fetchDVFPriceM2_2026({ lat, lon }) {
            // IMPORTANT : Les endpoints DVF varient. On tente un endpoint public utilisé couramment.
            // Si indisponible (CORS), on lèvera une erreur et on tombera en fallback.
            // Endpoint (tentative) : https://api.cquest.org/dvf?lat=...&lon=...&dist=...&from=YYYY-MM-DD&to=YYYY-MM-DD
            // cquest est une API communautaire couramment utilisée pour DVF (peut évoluer).
            const from = `${PRICE_TARGET_YEAR}-01-01`;
            const to = `${PRICE_TARGET_YEAR}-12-31`;
            const dist = 2000; // 2 km autour du centre de commune
            const url = `https://api.cquest.org/dvf?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&dist=${dist}&from=${from}&to=${to}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('DVF endpoint not reachable');
            const data = await res.json();
            const feats = data?.features || [];

            // On calcule une médiane €/m² sur les mutations avec surface
            const prices = [];
            for (const f of feats) {
                const p = f.properties || {};
                const valeur = Number(p.valeur_fonciere);
                const surface = Number(p.surface_reelle_bati || p.surface_terrain || p.surface_bati || 0);
                if (valeur > 0 && surface > 10) {
                    prices.push(valeur / surface);
                }
            }
            if (prices.length < 8) throw new Error('Not enough DVF samples');
            prices.sort((a, b) => a - b);
            const mid = Math.floor(prices.length / 2);
            const median = prices.length % 2 ? prices[mid] : (prices[mid - 1] + prices[mid]) / 2;
            return { value: median, sampleSize: prices.length, radiusM: dist };
        }

        async function resolvePricePerM2(cityZone) {
            const key = normalizeText(cityZone);
            const cache = getPriceCache();
            const cached = cache[key];
            const now = Date.now();
            const maxAgeMs = 1000 * 60 * 60 * 24 * 7; // 7 jours

            if (cached && cached.value && (now - cached.ts) < maxAgeMs) {
                setPriceM2UI({
                    value: cached.value,
                    status: 'Cache',
                    meta: `Source : DVF (Etalab) • Période : ${PRICE_TARGET_YEAR} • MAJ : ${new Date(cached.ts).toLocaleDateString('fr-FR')}`
                });
                return cached.value;
            }

            setPriceM2UI({ value: null, status: 'Chargement…', meta: `Source : DVF (Etalab) • Période : ${PRICE_TARGET_YEAR}` });

            // 1) fallback local immédiat si champ vide
            if (!cityZone || key.length < 2) {
                const local = getLocalCityPrice(cityZone || '');
                setPriceM2UI({ value: local, status: 'Fallback', meta: `Source : Liste locale (approx.) • Période : ${PRICE_TARGET_YEAR}` });
                return local;
            }

            // DVF disabled for reliability - use local data only (2026)
            const local = getLocalCityPrice(cityZone);
            setPriceM2UI({
                value: local,
                status: 'Local 2026',
                meta: `Source : MeilleursAgents/Notaires France 2026`
            });
            return local;
        }

        async function calculateGeneralPropertyData() {
            // Get values
            const cityZoneInput = document.getElementById('city-zone');
            const cityZone = cityZoneInput ? cityZoneInput.value : '';
            const propertyType = document.getElementById('property-type').value;
            const propertyState = document.getElementById('property-state').value || 'ancien';
            const surface = parseFloat(document.getElementById('surface').value) || 0;
            const purchasePrice = parseFloat(document.getElementById('purchase-price').value) || 0;
            
            // 1. Trouver le prix de base de la ville
            let basePrice = getLocalCityPrice(cityZone);

            // 2. AJUSTEMENT TYPE DE BIEN (MAISON +10%)
            let adjustedPricePerM2 = basePrice;
            if (propertyType === 'maison') {
                adjustedPricePerM2 = basePrice * 1.1;
            }

            // Mettre à jour l'affichage du prix au m2
            const priceEl = document.getElementById('price-per-m2');
            if (priceEl) {
                priceEl.textContent = Math.round(adjustedPricePerM2).toLocaleString('fr-FR') + ' €/m²';
            }
            
            const metaEl = document.getElementById('price-per-m2-meta');
            if (metaEl) {
                metaEl.textContent = `Source : Références 2026 • Type : ${propertyType || '—'}`;
            }

            // Property tax (estimate based on surface and state)
            let propertyTax = 0;
            if (propertyState === 'ancien') {
                propertyTax = Math.round(surface * 12);
            } else {
                propertyTax = Math.round(surface * 8);
            }
            
            // Notary fees
            let notaryFees = 0;
            if (propertyState === 'neuf') {
                notaryFees = purchasePrice * 0.025;
            } else {
                notaryFees = purchasePrice * 0.08;
            }

            if (document.getElementById('property-tax-est')) {
                document.getElementById('property-tax-est').textContent = propertyTax.toLocaleString('fr-FR') + ' €/an';
            }
            if (document.getElementById('notary-fees')) {
                document.getElementById('notary-fees').textContent = Math.round(notaryFees).toLocaleString('fr-FR') + ' €';
            }

            if (surface <= 0 || purchasePrice <= 0) return;

            // Ajustement pour la valeur de marché (comparatif)
            let marketValuePerM2 = adjustedPricePerM2;
            if (propertyState === 'neuf') marketValuePerM2 *= 1.2;
            
            // Calculate market value of this property
            const marketValue = marketValuePerM2 * surface;
            
            // Calculate price comparison (%)
            const priceDiffPct = ((purchasePrice - marketValue) / marketValue) * 100;
            
            let comparisonText = '';
            let comparisonClass = '';
            
            if (priceDiffPct > 5) {
                comparisonText = `⚠️ +${Math.abs(Math.round(priceDiffPct))}% au-dessus`;
                comparisonClass = 'text-red-600';
            } else if (priceDiffPct < -5) {
                comparisonText = `✓ -${Math.abs(Math.round(priceDiffPct))}% en dessous`;
                comparisonClass = 'text-green-600';
            } else {
                comparisonText = '✓ Au prix du marché';
                comparisonClass = 'text-yellow-600';
            }
            
            // Update UI
            if (document.getElementById('price-comparison')) {
                const comparisonEl = document.getElementById('price-comparison');
                comparisonEl.textContent = comparisonText;
                comparisonEl.className = 'text-xl font-bold ' + comparisonClass;
            }
            
            // If we are in specific strategy sections, update them too
            if (selectedStrategy === 'cashflow') calculateCashflowData();
            if (selectedStrategy === 'resale') calculateResaleData();
        }

        // Travaux: pourcentages indicatifs (modifiable facilement ici)
        const WORKS_PRESETS = {
            aucun: { pct: 0.00, label: 'Aucun', desc: "Aucun travaux : bien en état d'usage / habitable." },
            raffraichissement: { pct: 0.03, label: 'Raffraichissement', desc: "Raffraichissement : peintures, sols, petits ajustements." },
            renovation: { pct: 0.08, label: 'Rénovation', desc: "Rénovation : cuisine/SDB, électricité/plomberie partielle." },
            rehabilitation: { pct: 0.20, label: 'Réhabilitation', desc: "Réhabilitation : travaux lourds, reprise globale du logement." },
            custom: { pct: null, label: 'Montant exact', desc: "Montant exact : saisissez votre budget travaux." }
        };

        function setGeneralWorksPriceByLevel(level) {
            const worksPriceInput = document.getElementById('works-price');
            const purchasePrice = parseFloat(document.getElementById('purchase-price')?.value) || 300000;

            updateWorksDescription(level);

            const preset = WORKS_PRESETS[level];
            if (!preset) return;
            if (preset.pct === null) return;

            worksPriceInput.value = Math.round(purchasePrice * preset.pct);
        }
        
        function setResaleWorksPriceByLevel(level) {
            const worksPriceInput = document.getElementById('rs-works-price');
            const purchasePrice = parseFloat(document.getElementById('rs-purchase-price')?.value) || 300000;

            updateResaleWorksDescription(level);

            const preset = WORKS_PRESETS[level];
            if (!preset) return;
            if (preset.pct === null) return;

            worksPriceInput.value = Math.round(purchasePrice * preset.pct);
        }
        
        function calculateCashflowData() {
            // Get values from general property section
            const purchasePrice = parseFloat(document.getElementById('purchase-price')?.value) || 300000;
            const surface = parseFloat(document.getElementById('surface')?.value) || 60;
            const worksPrice = parseFloat(document.getElementById('works-price')?.value) || 0;
            const propertyState = document.getElementById('property-state')?.value || 'ancien';
            
            // Get cashflow specific values
            const rentType = document.getElementById('rent-type')?.value || 'Vide';
            const rentBase = parseFloat(document.getElementById('rent-price')?.value) || 1200;
            const charges = parseFloat(document.getElementById('charges')?.value) || 300;
            const loanTerm = parseFloat(document.getElementById('loan-term')?.value) || 20;
            const interestRateInput = parseFloat(document.getElementById('interest-rate')?.value) || 3.30;
            const interestRate = interestRateInput / 100; // Convert percentage to decimal

            // Rent uplift by rent type (simple model)
            // Vide: base
            // Meublé: +15% (souvent +10 à +20% selon zones)
            // Courte durée: +35% mais charges +15% (turnover/plateformes/entretien)
            const rentMultipliers = {
                'Vide': 1.00,
                'Meublé': 1.15,
                'Courte durée': 1.35
            };
            const chargeMultipliers = {
                'Vide': 1.00,
                'Meublé': 1.05,
                'Courte durée': 1.15
            };

            const rentPrice = rentBase * (rentMultipliers[rentType] ?? 1.0);
            const chargesAdj = charges * (chargeMultipliers[rentType] ?? 1.0);
            
            // Calculate notary fees (same as general property calculation)
            let notaryFees;
            if (propertyState === 'neuf') {
                notaryFees = purchasePrice * 0.025; // 2.5% for new
            } else {
                notaryFees = purchasePrice * 0.08; // 8% for old
            }
            
            // Property tax (same as general property calculation)
            let propertyTax;
            if (propertyState === 'ancien') {
                propertyTax = Math.round(surface * 12); // 12€/m²/an for old
            } else {
                propertyTax = Math.round(surface * 8); // 8€/m²/an for new
            }
            
            // Total amount to finance = Purchase price + Works + Notary fees
            const totalAmountToFinance = purchasePrice + worksPrice + notaryFees;
            
            // Monthly payment calculation using annuity formula
            const monthlyRate = interestRate / 12;
            const totalPayments = loanTerm * 12;
            
            let monthlyPayment;
            if (monthlyRate > 0) {
                monthlyPayment = totalAmountToFinance * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) 
                                / (Math.pow(1 + monthlyRate, totalPayments) - 1);
            } else {
                monthlyPayment = totalAmountToFinance / totalPayments;
            }
            
            // Cash-flow net = Rent - Charges - Monthly payment
            const cashflowNet = rentPrice - chargesAdj - monthlyPayment;
            
            // Total investment (for yield calculation)
            const totalInvestment = purchasePrice + notaryFees + worksPrice;
            
            // Yield calculation = (Annual cashflow / Total investment) × 100
            const annualCashflow = cashflowNet * 12;
            const yieldNet = (annualCashflow / totalInvestment) * 100;
            
            // Update UI
            if (document.getElementById('cf-notary-fees')) {
                document.getElementById('cf-notary-fees').textContent = Math.round(notaryFees).toLocaleString('fr-FR') + ' €';
            }
            if (document.getElementById('cf-property-tax')) {
                document.getElementById('cf-property-tax').textContent = propertyTax.toLocaleString('fr-FR') + ' €/an';
            }
            if (document.getElementById('monthly-payment')) {
                document.getElementById('monthly-payment').textContent = Math.round(monthlyPayment).toLocaleString('fr-FR') + ' €/mois';
            }
            if (document.getElementById('monthly-payment-detail')) {
                document.getElementById('monthly-payment-detail').innerHTML = 
                    `Montant financé : <strong>${Math.round(totalAmountToFinance).toLocaleString('fr-FR')} €</strong> (${Math.round(purchasePrice).toLocaleString('fr-FR')} € + ${Math.round(worksPrice).toLocaleString('fr-FR')} € travaux + ${Math.round(notaryFees).toLocaleString('fr-FR')} € notaire) sur <strong>${loanTerm} ans</strong> à <strong>${interestRateInput}%</strong>`;
            }

            if (document.getElementById('yield-net')) {
                const yieldElement = document.getElementById('yield-net');
                yieldElement.textContent = yieldNet.toFixed(2) + ' %';
                yieldElement.className = yieldNet > 3 ? 'text-2xl font-extrabold text-blue-700' : 'text-2xl font-extrabold text-orange-700';
            }
        }
        
        function calculateResaleData() {
            // Get values from general property section (if available, otherwise use resale section values)
            let purchasePrice = parseFloat(document.getElementById('purchase-price')?.value) || 300000;
            let worksPrice = parseFloat(document.getElementById('works-price')?.value) || 15000;
            let propertyState = document.getElementById('property-state')?.value || 'ancien';
            
            // Override with resale section values if they exist
            if (document.getElementById('rs-purchase-price')?.value) {
                purchasePrice = parseFloat(document.getElementById('rs-purchase-price').value);
            }
            if (document.getElementById('rs-works-price')?.value) {
                worksPrice = parseFloat(document.getElementById('rs-works-price').value);
            }
            
            // Get resale specific values
            const resaleMode = document.getElementById('resale-mode')?.value || 'Agence';
            const resaleDuration = parseFloat(document.getElementById('resale-duration')?.value) || 2;
            
            // Calculate price evolution based on projection type
            let priceEvolution = 0.02; // 2% per year (realistic)
            if (projectionType === 'low') {
                priceEvolution = 0.005; // 0.5% per year
            } else if (projectionType === 'high') {
                priceEvolution = 0.05; // 5% per year
            }
            
            // Estimated resale price
            const resalePriceEst = purchasePrice * Math.pow(1 + priceEvolution, resaleDuration) + (worksPrice * 0.7);
            
            // Agency fees
            const agencyFees = resaleMode === 'Agence' ? resalePriceEst * 0.05 : 0;
            
            // Capital gains tax (simplified - 19% + 17.2% social contributions on net gain)
            const capitalGain = resalePriceEst - purchasePrice - worksPrice - agencyFees;
            const capitalGainsTax = capitalGain > 0 ? capitalGain * 0.362 : 0;
            
            // Net capital gain
            const netCapitalGain = resalePriceEst - purchasePrice - worksPrice - agencyFees - capitalGainsTax;
            
            // Calculate notary fees (same as general property calculation)
            let notaryFees;
            if (propertyState === 'neuf') {
                notaryFees = purchasePrice * 0.025; // 2.5% for new
            } else {
                notaryFees = purchasePrice * 0.08; // 8% for old
            }
            
            // Total investment
            const totalInvestment = purchasePrice + notaryFees + worksPrice;
            
            // Global yield
            const globalYield = (netCapitalGain / totalInvestment) * 100;
            
            // Update UI
            if (document.getElementById('resale-price-est')) {
                document.getElementById('resale-price-est').textContent = Math.round(resalePriceEst).toLocaleString('fr-FR') + ' €';
            }
            if (document.getElementById('agency-fees')) {
                document.getElementById('agency-fees').textContent = Math.round(agencyFees).toLocaleString('fr-FR') + ' €';
            }
            if (document.getElementById('capital-gains-tax')) {
                document.getElementById('capital-gains-tax').textContent = Math.round(capitalGainsTax).toLocaleString('fr-FR') + ' €';
            }
            if (document.getElementById('net-capital-gain')) {
                const gainElement = document.getElementById('net-capital-gain');
                gainElement.textContent = (netCapitalGain > 0 ? '+' : '') + Math.round(netCapitalGain).toLocaleString('fr-FR') + ' €';
                gainElement.className = netCapitalGain > 0 ? 'text-2xl font-extrabold text-emerald-700' : 'text-2xl font-extrabold text-red-700';
            }
            if (document.getElementById('global-yield')) {
                const yieldElement = document.getElementById('global-yield');
                yieldElement.textContent = globalYield.toFixed(1) + ' %';
                yieldElement.className = globalYield > 5 ? 'text-2xl font-extrabold text-emerald-700' : (globalYield > 0 ? 'text-2xl font-extrabold text-blue-700' : 'text-2xl font-extrabold text-red-700');
            }
        }
        
        function initializeCharts() {
            // Cost Distribution Chart
            const costCtx = document.getElementById('cost-chart').getContext('2d');
            new Chart(costCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Prix d\'achat', 'Frais de notaire', 'Travaux', 'Charges annuelles'],
                    datasets: [{
                        data: [300000, 24000, 15000, 1800],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.9)',
                            'rgba(249, 115, 22, 0.9)',
                            'rgba(59, 130, 246, 0.9)',
                            'rgba(245, 158, 11, 0.9)'
                        ],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    family: 'Poppins',
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
            
            // Trend Chart
            const trendCtx = document.getElementById('trend-chart').getContext('2d');
            new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: ['Année 1', 'Année 5', 'Année 10', 'Année 15'],
                    datasets: [
                        {
                            label: 'Rendement net (%)',
                            data: [3.8, 4.5, 4.8, 5.2],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(34, 197, 94, 0.7)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(16, 185, 129, 0.9)'
                            ],
                            borderRadius: 8,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Poppins',
                                    size: 13
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function analyzeProject(event) {
            // Display analysis feedback
            const btn = event?.currentTarget;
            if (!btn) {
                updateResults();
                document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }

            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i> Calcul en cours...';
            btn.disabled = true;
            btn.classList.add('opacity-75');
            
            setTimeout(() => {
                updateResults();
                btn.innerHTML = originalHTML;
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                
                // Scroll to results
                document.getElementById('results-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 800);
        }
        
        function updateResults() {
            // Get user input values
            const purchasePrice = parseFloat(document.getElementById('purchase-price')?.value) || 0;
            const surface = parseFloat(document.getElementById('surface')?.value) || 0;
            const rentType = document.getElementById('rent-type')?.value || 'Vide';
            const rentBase = parseFloat(document.getElementById('rent-price')?.value) || 0;
            const chargesBase = parseFloat(document.getElementById('charges')?.value) || 0;
            const loanTerm = parseFloat(document.getElementById('loan-term')?.value) || 0;
            const worksPrice = parseFloat(document.getElementById('works-price')?.value) || 0;
            const propertyState = document.getElementById('property-state')?.value || 'ancien';

            if (!purchasePrice || !surface || !loanTerm) return;

            // Rent uplift by rent type (keep consistent with step 3 calculations)
            const rentMultipliers = {
                'Vide': 1.00,
                'Meublé': 1.15,
                'Courte durée': 1.35
            };
            const chargeMultipliers = {
                'Vide': 1.00,
                'Meublé': 1.05,
                'Courte durée': 1.15
            };

            const rentPrice = rentBase * (rentMultipliers[rentType] ?? 1.0);
            const charges = chargesBase * (chargeMultipliers[rentType] ?? 1.0);

            // Taux : si l'utilisateur renseigne le champ avancé, on l'utilise. Sinon on prend le taux Banque de France.
            const advRateEl = document.getElementById('interest-rate-advanced');
            const rawRate = (advRateEl && advRateEl.value !== '') ? parseFloat(advRateEl.value) : parseFloat(document.getElementById('interest-rate')?.value);
            const interestRate = (rawRate || 3.85) / 100;

            // Notary fees cohérents
            const notaryFees = (propertyState === 'neuf') ? purchasePrice * 0.025 : purchasePrice * 0.08;

            // Montant financé = prix + travaux + notaire
            const totalAmountToFinance = purchasePrice + worksPrice + notaryFees;
            const totalInvestment = totalAmountToFinance;

            const monthlyRate = interestRate / 12;
            const totalPayments = loanTerm * 12;
            let monthlyPayment;
            if (monthlyRate > 0) {
                monthlyPayment = totalAmountToFinance * (monthlyRate * Math.pow(1 + monthlyRate, totalPayments)) / (Math.pow(1 + monthlyRate, totalPayments) - 1);
            } else {
                monthlyPayment = totalAmountToFinance / totalPayments;
            }

            // Cashflow calculation
            let cashflow = rentPrice - charges - monthlyPayment;

            // Yield calculation
            const annualCashflow = cashflow * 12;
            const yieldRate = (annualCashflow / totalInvestment) * 100;
            
            // Display results
            document.getElementById('cashflow-result').textContent = 
                (cashflow > 0 ? '+' : '') + Math.round(cashflow).toLocaleString('fr-FR') + ' €';
            document.getElementById('yield-result').textContent = 
                yieldRate.toFixed(1) + ' %';
            
            document.getElementById('total-investment').textContent = 
                Math.round(totalInvestment).toLocaleString('fr-FR') + ' €';
            document.getElementById('annual-cashflow').textContent = 
                Math.round(annualCashflow).toLocaleString('fr-FR') + ' €';
            document.getElementById('total-yield').textContent = 
                yieldRate.toFixed(1) + ' %';
            
            // Risk level determination
            let riskLevel = 'Élevé';
            let riskClass = 'risk-high';
            
            if (yieldRate > 4.0 && cashflow > 0) {
                riskLevel = 'Faible';
                riskClass = 'risk-low';
                document.getElementById('evaluation').innerHTML = 
                    '<h3 class="text-2xl font-semibold text-emerald-700 mb-3"><i class="fas fa-check-circle mr-2"></i> Évaluation globale</h3>' +
                    '<p class="text-lg text-emerald-800 leading-relaxed"><strong>Affaire rentable</strong> : Le rendement est au dessus des standards du marché. ' +
                    'L\'affaire présente un excellent équilibre entre rentabilité et sécurité.</p>';
                document.getElementById('verdict-btn').innerHTML = '<i class="fas fa-check-circle mr-2"></i> FAIRE OFFRE';
                document.getElementById('verdict-btn').className = 
                    'bg-gradient-to-r from-emerald-600 to-green-700 hover:from-green-700 hover:to-emerald-600 text-white font-semibold py-3 px-10 rounded-xl transition-all text-lg';
            } else if (yieldRate > 3.0 && cashflow > -50) {
                riskLevel = 'Modéré';
                riskClass = 'risk-medium';
            }
            
            document.getElementById('risk-level').textContent = riskLevel;
            
            // Update evaluation
            document.getElementById('evaluation').className = riskClass;
        }
        
        function exportToPDF() {
            alert('Fonction d\'export en PDF (version démo). Pour la version complète, veuillez contacter le support.');
        }
        
        function exportToExcel() {
            alert('Fonction d\'export en Excel (version démo). Pour la version complète, veuillez contacter le support.');
        }
        
        function formatPct(pct) {
            if (pct === null || pct === undefined) return '';
            return Math.round(pct * 100) + '%';
        }

        // Type de location : explication courte + impact sur cash-flow (loyer & charges)
        function getRentTypeModel(rentType) {
            const rentMultipliers = {
                'Vide': 1.00,
                'Meublé': 1.15,
                'Courte durée': 1.35
            };
            const chargeMultipliers = {
                'Vide': 1.00,
                'Meublé': 1.05,
                'Courte durée': 1.15
            };
            const rm = rentMultipliers[rentType] ?? 1.0;
            const cm = chargeMultipliers[rentType] ?? 1.0;

            const texts = {
                'Vide': `Location classique : base de référence (loyer × ${rm.toFixed(2)}, charges × ${cm.toFixed(2)}).`,
                'Meublé': `Meublé : cash-flow souvent amélioré (loyer +15%) mais charges un peu plus élevées (+5%).`,
                'Courte durée': `Courte durée : cash-flow potentiellement plus élevé (loyer +35%) mais charges/turnover plus importants (+15%).`
            };

            return { rm, cm, text: texts[rentType] || `Impact : loyer × ${rm.toFixed(2)}, charges × ${cm.toFixed(2)}.` };
        }

        function updateRentTypeHelp() {
            const help = document.querySelector('#rent-type-help span');
            const rentType = document.getElementById('rent-type')?.value || 'Vide';
            if (!help) return;
            help.textContent = getRentTypeModel(rentType).text;
        }

        function updateWorksDescription(level) {
            const descriptionEl = document.querySelector('#works-description span');
            const containerEl = document.getElementById('works-description');
            if (!containerEl || !descriptionEl) return;

            const preset = WORKS_PRESETS[level];
            if (!preset) {
                containerEl.style.display = 'none';
                return;
            }

            containerEl.style.display = 'flex';
            const pctText = preset.pct === null ? '' : ` (${formatPct(preset.pct)} du prix)`;
            descriptionEl.textContent = preset.desc + (preset.pct === null ? '' : ` ${pctText}`);
        }
        
        function updateResaleWorksDescription(level) {
            const descriptionEl = document.querySelector('#rs-works-description span');
            const containerEl = document.getElementById('rs-works-description');
            if (!containerEl || !descriptionEl) return;

            const preset = WORKS_PRESETS[level];
            if (!preset) {
                containerEl.style.display = 'none';
                return;
            }

            containerEl.style.display = 'flex';
            const pctText = preset.pct === null ? '' : ` (${formatPct(preset.pct)} du prix)`;
            descriptionEl.textContent = preset.desc + (preset.pct === null ? '' : ` ${pctText}`);
        }
    </script>
</body>
</html>
